# ==============================================================================
# Prometheus Configuration
# ==============================================================================
# Scrape configs for Enterprise AI Decision System services
# ==============================================================================

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'enterprise-ai'
    environment: 'production'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Rule files
rule_files:
  - /etc/prometheus/alerting_rules.yml
  - /etc/prometheus/recording_rules.yml

# ==============================================================================
# Scrape Configurations
# ==============================================================================

scrape_configs:
  # --------------------------------------------------------------------------
  # Prometheus self-monitoring
  # --------------------------------------------------------------------------
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # --------------------------------------------------------------------------
  # Prediction Service
  # --------------------------------------------------------------------------
  - job_name: 'predict-service'
    metrics_path: /metrics
    static_configs:
      - targets: ['predict-api:8000']
        labels:
          service: 'predict'
          team: 'ml-platform'
    
    # Kubernetes service discovery alternative
    # kubernetes_sd_configs:
    #   - role: pod
    #     namespaces:
    #       names: ['ml-services']
    # relabel_configs:
    #   - source_labels: [__meta_kubernetes_pod_label_app]
    #     action: keep
    #     regex: predict
    #   - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
    #     action: keep
    #     regex: true
    #   - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
    #     action: replace
    #     target_label: __metrics_path__
    #     regex: (.+)

  # --------------------------------------------------------------------------
  # RAG Service
  # --------------------------------------------------------------------------
  - job_name: 'rag-service'
    metrics_path: /metrics
    static_configs:
      - targets: ['rag-api:8001']
        labels:
          service: 'rag'
          team: 'ml-platform'

  # --------------------------------------------------------------------------
  # MLflow Server
  # --------------------------------------------------------------------------
  - job_name: 'mlflow'
    metrics_path: /metrics
    static_configs:
      - targets: ['mlflow:5000']
        labels:
          service: 'mlflow'

  # --------------------------------------------------------------------------
  # Kafka Exporter
  # --------------------------------------------------------------------------
  - job_name: 'kafka-exporter'
    static_configs:
      - targets: ['kafka-exporter:9308']
        labels:
          service: 'kafka'
    
    # For Kafka JMX metrics
    # metric_relabel_configs:
    #   - source_labels: [topic]
    #     regex: '__.*'
    #     action: drop

  # --------------------------------------------------------------------------
  # Spark Applications (Pushgateway)
  # --------------------------------------------------------------------------
  - job_name: 'spark-pushgateway'
    honor_labels: true
    static_configs:
      - targets: ['pushgateway:9091']
        labels:
          service: 'spark'

  # --------------------------------------------------------------------------
  # Model Drift Exporter (Custom)
  # --------------------------------------------------------------------------
  - job_name: 'model-drift'
    scrape_interval: 60s
    static_configs:
      - targets: ['drift-exporter:8080']
        labels:
          service: 'model-monitoring'

  # --------------------------------------------------------------------------
  # Airflow
  # --------------------------------------------------------------------------
  - job_name: 'airflow'
    metrics_path: /admin/metrics
    static_configs:
      - targets: ['airflow-webserver:8080']
        labels:
          service: 'airflow'

  # --------------------------------------------------------------------------
  # Node Exporter (Infrastructure)
  # --------------------------------------------------------------------------
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
    
    # Kubernetes node discovery
    # kubernetes_sd_configs:
    #   - role: node
    # relabel_configs:
    #   - action: labelmap
    #     regex: __meta_kubernetes_node_label_(.+)

  # --------------------------------------------------------------------------
  # Agent Core Metrics
  # --------------------------------------------------------------------------
  - job_name: 'agent-core'
    metrics_path: /metrics
    static_configs:
      - targets: ['agent-api:8002']
        labels:
          service: 'agent'
